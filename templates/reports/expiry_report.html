{% extends "base.html" %}
{% block content %}
<style>
.low-stock-row {
    background-color: #ffe5e5 !important;   /* light red */
}

.expiring-soon-row {
    background-color: #fff4cc !important;   /* light yellow */
}
</style>

<h2>Expiry Report</h2>

<!-- Report Selector -->
<div style="display:flex; gap:20px; margin-bottom:20px; align-items:flex-end;">
    <div>
        <label>Select Report</label>
        <select id="report-select" style="padding:6px; width:200px;">
            <option value="/reports/stock"  {% if 'stock' in request.path %}selected{% endif %}>Stock Report</option>
            <option value="/reports/sales"  {% if 'sales' in request.path %}selected{% endif %}>Sales Report</option>
            <option value="/reports/expiry" {% if 'expiry' in request.path %}selected{% endif %}>Expiry Report</option>
        </select>
    </div>
</div>

<script>
document.getElementById('report-select').addEventListener('change', function() {
    window.location.href = this.value;
});
</script>

<!-- â­ ADD TABLE ID HERE -->
<table id="expiryTable" border="0" cellpadding="6" cellspacing="0"
       style="width:100%; background:white; border-radius:8px; overflow:hidden;">

    <thead style="background:#f1f1f1;">
        <tr>
            <th onclick="sortTable('expiryTable', 0)" style="cursor:pointer;" align="left">SKU</th>
            <th onclick="sortTable('expiryTable', 1)" style="cursor:pointer;" align="left">Name</th>
            <th onclick="sortTable('expiryTable', 2)" style="cursor:pointer;" align="left">Brand</th>
            <th onclick="sortTable('expiryTable', 3)" style="cursor:pointer;" align="left">Batch</th>
            <th onclick="sortTable('expiryTable', 4)" style="cursor:pointer;" align="left">Expiry</th>
            <th onclick="sortTable('expiryTable', 5)" style="cursor:pointer;" align="right">Stock</th>
        </tr>
    </thead>

<tbody>
    {% set ns = namespace(total_stock=0) %}

    {% for p in products.items %}
        {% set ns.total_stock = ns.total_stock + (p.current_stock or 0) %}

        {% set expired = (p.expiry_date and p.expiry_date <= current_date) %}
        {% set expiring_soon = (p.expiry_date and p.expiry_date > current_date and p.expiry_date <= soon_date) %}

        <tr
            class="
                {% if expired %}low-stock-row
                {% elif expiring_soon %}expiring-soon-row
                {% endif %}
            "
        >
            <td>{{ p.sku }}</td>
            <td>{{ p.name }}</td>
            <td>{{ p.brand or '-' }}</td>
            <td>{{ p.batch_no or '-' }}</td>
            <td>{{ p.expiry_date or '-' }}</td>
            <td align="right">{{ p.current_stock or 0 }}</td>
        </tr>
    {% endfor %}
</tbody>

<tfoot>
    <tr>
        <td colspan="5" align="right"><strong>Total Stock:</strong></td>
        <td align="right"><strong>{{ ns.total_stock }}</strong></td>
    </tr>
</tfoot>
</table>

<div style="text-align: right; margin-top: 15px;">
    {% if products.has_prev %}
        <a href="{{ url_for('report_expiry', page=products.prev_num) }}" class="btn btn-secondary">Previous</a>
    {% endif %}
    {% if products.has_next %}
        <a href="{{ url_for('report_expiry', page=products.next_num) }}" class="btn btn-primary">Next</a>
    {% endif %}
</div>

{% endblock %}
